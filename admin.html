<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Classic Decor</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="admin.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>
  <body>
    <header class="header">
      <div class="logo">
        <a href="index.html" class="logo-text">Classic Decor</a>
      </div>
      <nav>
        <ul></ul>
      </nav>
      <div class="header-actions">
        <a href="shop.html" class="icon-btn" title="Shop"
          ><i class="fa-solid fa-store"></i
        ></a>
        <a href="#" id="search-toggle" class="icon-btn" title="Search"
          ><i class="fa-solid fa-magnifying-glass"></i
        ></a>
        <a href="login.html" class="icon-btn" title="Account"
          ><i class="fa-regular fa-user"></i
        ></a>
        <a href="cart.html" class="icon-btn" title="Cart"
          ><i class="fa-solid fa-cart-shopping"></i
          ><span id="nav-cart-count">0</span></a
        >
      </div>
    </header>
    <div id="search-overlay" class="search-overlay" aria-hidden="true">
      <div class="search-panel">
        <button
          id="search-close"
          class="search-close"
          aria-label="Close search"
        >
          &times;
        </button>
        <form id="search-form" class="search-form" role="search">
          <input
            id="search-input"
            type="search"
            name="q"
            placeholder="Search products, categories..."
            aria-label="Search"
            autocomplete="off"
          />
          <button type="submit" class="search-submit">Search</button>
        </form>
      </div>
    </div>
    <nav class="category-nav">
      <div class="category-container">
        <ul>
          <li><a href="categories.html?category=wall-art">Wall Art</a></li>
          <li>
            <a href="categories.html?category=wall-mirrors">Wall Mirrors</a>
          </li>
          <li>
            <a href="categories.html?category=wall-clocks">Wall Clocks</a>
          </li>
          <li>
            <a href="categories.html?category=name-plates">Name Plates</a>
          </li>
          <li>
            <a href="categories.html?category=photo-frames">Photo Frames</a>
          </li>
          <li><a href="categories.html?category=kids-decor">Kids Decor</a></li>
          <li><a href="categories.html?category=shelves">Shelves</a></li>
          <li><a href="categories.html?category=vases">Flower Vases</a></li>
        </ul>
      </div>
    </nav>

    <main>
      <section class="auth-section">
        <div class="auth-container">
          <h2>Admin Dashboard</h2>
          <div
            id="admin-status"
            style="margin-bottom: 10px; color: #f44336"
          ></div>
          <div id="admin-content" style="display: none">
            <div
              style="
                margin-bottom: 18px;
                border: 1px solid #eee;
                border-radius: 8px;
                padding: 12px;
              "
            >
              <h3 style="margin-top: 0">Create / Update Product</h3>
              <form id="product-form" class="auth-form">
                <input type="hidden" id="prod-id" />
                <div class="form-group">
                  <label>Name</label><input id="prod-name" required />
                </div>
                <div class="form-group">
                  <label>Price</label
                  ><input id="prod-price" type="number" min="0" required />
                </div>
                <div class="form-group">
                  <label>Category</label>
                  <div style="display: flex; gap: 8px; align-items: center">
                    <select
                      id="prod-category-select"
                      style="
                        padding: 8px;
                        border-radius: 6px;
                        border: 1px solid var(--border);
                        min-width: 180px;
                      "
                    >
                      <option value="">-- Loading categories --</option>
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label>Product Image</label>
                  <div style="display: flex; gap: 8px; align-items: center">
                    <input
                      id="prod-image"
                      readonly
                      placeholder="/images/your-image.jpg"
                      style="
                        flex: 1;
                        padding: 8px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                      "
                    />
                    <input
                      type="file"
                      id="prod-image-file"
                      accept="image/*"
                      style="display: none"
                    />
                    <label for="prod-image-file" class="file-btn"
                      >Choose file</label
                    >
                    <div
                      id="image-preview"
                      style="
                        display: inline-block;
                        margin-left: 10px;
                        vertical-align: middle;
                      "
                    ></div>
                  </div>
                </div>
                <div class="form-group">
                  <label>Stock</label
                  ><input id="prod-stock" type="number" min="0" value="0" />
                </div>
                <div class="form-group">
                  <label>Status</label
                  ><input
                    id="prod-status"
                    placeholder="active/inactive"
                    value="active"
                  />
                </div>
                <div class="form-group">
                  <label>Slug</label><input id="prod-slug" />
                </div>
                <div class="form-group">
                  <label>Meta Title</label><input id="prod-metaTitle" />
                </div>
                <div class="form-group">
                  <label>Meta Description</label
                  ><input id="prod-metaDescription" />
                </div>
                <div class="form-group">
                  <label>Sizes (comma-separated)</label
                  ><input
                    id="prod-sizes"
                    placeholder="Small 12 inches, Medium 16 inches"
                  />
                </div>
                <div class="form-group">
                  <label>Colors (comma-separated)</label
                  ><input
                    id="prod-colors"
                    placeholder="Golden/Black, Silver/Black"
                  />
                </div>
                <div class="auth-actions">
                  <button type="submit" class="submit-btn" id="prod-submit">
                    Save Product
                  </button>
                </div>
              </form>
            </div>

            <div
              style="border: 1px solid #eee; border-radius: 8px; padding: 12px"
            >
              <h3 style="margin-top: 0">Products</h3>
              <div id="products-list"></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div class="footer-bottom">
        <p>&copy; 2025 Classic Decor. All Rights Reserved.</p>
      </div>
    </footer>

    <script src="cart.js"></script>
    <script src="script.js"></script>
    <script>
      const API_BASE =
        location.protocol === "file:" ? "http://localhost:3001" : "";
      const token = localStorage.getItem("authToken");
      let user = null;
      try {
        user = JSON.parse(localStorage.getItem("currentUser") || "null");
      } catch (_) {
        user = null;
      }
      const statusBox = document.getElementById("admin-status");
      const contentBox = document.getElementById("admin-content");
      if (!token || !user) {
        statusBox.textContent = "Login required";
      } else if (user.role !== "admin") {
        statusBox.textContent = "Admin access required";
      } else {
        statusBox.textContent = "";
        contentBox.style.display = "";
      }

      async function api(path, options) {
        const resp = await fetch(
          API_BASE + path,
          Object.assign(
            {
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
            },
            options || {}
          )
        );
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(data.error || "Request failed");
        return data;
      }

      async function loadProducts() {
        const data = await api("/api/products", {
          headers: { Authorization: "Bearer " + token },
        });
        const box = document.getElementById("products-list");
        if (!Array.isArray(data) || data.length === 0) {
          box.innerHTML = "<em>No products</em>";
          return;
        }
        box.innerHTML = data
          .map(
            (p) => `
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:8px;align-items:center;border-bottom:1px solid #eee;padding:8px 0;">
          <div>
            <div><strong>${p.name}</strong></div>
            <div style="color:#555;">${p.category || ""}</div>
          </div>
          <div>PKR ${Number(p.price || 0).toFixed(0)}</div>
          <div>
            <button class="submit-btn" style="padding:6px 12px" data-edit="${
              p.id
            }">Edit</button>
          </div>
          <div>
            <button class="remove-item" style="padding:6px 12px" data-del="${
              p.id
            }">Delete</button>
          </div>
        </div>
      `
          )
          .join("");
      }

      function readForm() {
        const variants = {
          sizes: (document.getElementById("prod-sizes").value || "")
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean),
          colors: (document.getElementById("prod-colors").value || "")
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean),
        };
        const category =
          document.getElementById("prod-category-select").value || "";
        return {
          name: document.getElementById("prod-name").value,
          price: Number(document.getElementById("prod-price").value || 0),
          category: category,
          image: document.getElementById("prod-image").value,
          stock: Number(document.getElementById("prod-stock").value || 0),
          status: document.getElementById("prod-status").value,
          slug: document.getElementById("prod-slug").value,
          metaTitle: document.getElementById("prod-metaTitle").value,
          metaDescription: document.getElementById("prod-metaDescription")
            .value,
          variants,
        };
      }

      function fillForm(p) {
        document.getElementById("prod-id").value = p.id || "";
        document.getElementById("prod-name").value = p.name || "";
        document.getElementById("prod-price").value = p.price || 0;
        // set category select/value if it matches one of the allowed options
        const select = document.getElementById("prod-category-select");
        const foundOpt = Array.from(select.options).some(
          (o) => o.value === (p.category || "")
        );
        select.value = foundOpt ? p.category : "";
        document.getElementById("prod-image").value = p.image || "";
        document.getElementById("prod-stock").value = p.stock || 0;
        document.getElementById("prod-status").value = p.status || "active";
        document.getElementById("prod-slug").value = p.slug || "";
        document.getElementById("prod-metaTitle").value = p.metaTitle || "";
        document.getElementById("prod-metaDescription").value =
          p.metaDescription || "";
        const sizes =
          p.variants && p.variants.sizes ? p.variants.sizes.join(", ") : "";
        const colors =
          p.variants && p.variants.colors ? p.variants.colors.join(", ") : "";
        document.getElementById("prod-sizes").value = sizes;
        document.getElementById("prod-colors").value = colors;
        document.getElementById("prod-submit").textContent = "Update Product";
      }

      // no custom categories â€” selection restricted to defaults

      document
        .getElementById("product-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const id = document.getElementById("prod-id").value;
          const body = JSON.stringify(readForm());
          if (!id) {
            await api("/api/products", { method: "POST", body });
          } else {
            await api("/api/products/" + id, { method: "PUT", body });
          }
          this.reset();
          document.getElementById("prod-submit").textContent = "Save Product";
          if (window.showMessage) window.showMessage("Saved", "success");
          loadProducts();
        });

      // Image upload from local PC
      document
        .getElementById("prod-image-file")
        .addEventListener("change", async function () {
          const f = this.files && this.files[0];
          if (!f) return;
          try {
            const fd = new FormData();
            fd.append("image", f);
            const resp = await fetch(API_BASE + "/api/upload", {
              method: "POST",
              body: fd,
              headers: { Authorization: "Bearer " + token },
            });
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) throw new Error(data.error || "Upload failed");
            document.getElementById("prod-image").value = data.url;
            const pv = document.getElementById("image-preview");
            pv.innerHTML = "";
            const pimg = document.createElement("img");
            pimg.src = data.url;
            pimg.style.height = "40px";
            pimg.style.objectFit = "cover";
            pimg.style.border = "1px solid #ddd";
            pimg.style.borderRadius = "4px";
            pv.appendChild(pimg);
          } catch (err) {
            console.error("Image upload failed", err);
            alert(
              "Image upload failed: " + (err && err.message ? err.message : err)
            );
          }
        });

      // preview image when user pastes URL into the readonly input (optional)
      document
        .getElementById("prod-image")
        .addEventListener("input", function () {
          const v = this.value.trim();
          const pv = document.getElementById("image-preview");
          pv.innerHTML = "";
          if (v) {
            const i = document.createElement("img");
            i.src = v;
            i.style.height = "40px";
            i.style.objectFit = "cover";
            i.style.border = "1px solid #ddd";
            i.style.borderRadius = "4px";
            pv.appendChild(i);
          }
        });

      document.addEventListener("click", async function (e) {
        const editBtn = e.target.closest("[data-edit]");
        if (editBtn) {
          const id = editBtn.getAttribute("data-edit");
          const list = await api("/api/products", {
            headers: { Authorization: "Bearer " + token },
          });
          const p = list.find((x) => String(x.id) === String(id));
          if (p) fillForm(p);
        }
        const delBtn = e.target.closest("[data-del]");
        if (delBtn) {
          const id = delBtn.getAttribute("data-del");
          if (confirm("Delete product?")) {
            await api("/api/products/" + id, { method: "DELETE" });
            if (window.showMessage) window.showMessage("Deleted", "success");
            loadProducts();
          }
        }
      });

      if (token && user && user.role === "admin") loadProducts();

      // Load categories dynamically for the admin category select
      (function () {
        const API_BASE =
          location.protocol === "file:" ? "http://localhost:3001" : "";
        const defaultCats = [
          { id: "wall-art", name: "Wall Art" },
          { id: "wall-mirrors", name: "Wall Mirrors" },
          { id: "wall-clocks", name: "Wall Clocks" },
          { id: "name-plates", name: "Name Plates" },
          { id: "photo-frames", name: "Photo Frames" },
          { id: "kids-decor", name: "Kids Decor" },
          { id: "shelves", name: "Shelves" },
          { id: "vases", name: "Flower Vases" },
        ];

        function normalize(id) {
          return String(id || "")
            .toLowerCase()
            .trim()
            .replace(/\s+/g, "-")
            .replace(/[^a-z0-9\-]/g, "");
        }

        function merge(defaults, server) {
          const map = new Map();
          defaults.forEach((d) => map.set(d.id, { id: d.id, name: d.name }));
          (server || []).forEach((s) => {
            const id = s.id || s.name;
            const nid = normalize(id);
            if (!nid) return;
            if (map.has(nid)) return; // keep default order
            map.set(nid, { id: nid, name: s.name || s.id || nid });
          });
          // result: defaults first, then extras
          const res = [];
          defaults.forEach((d) => res.push(map.get(d.id)));
          Array.from(map.keys()).forEach((k) => {
            if (!defaults.some((d) => d.id === k)) res.push(map.get(k));
          });
          return res;
        }

        async function loadAdminCats() {
          const sel = document.getElementById("prod-category-select");
          if (!sel) return;
          try {
            const r = await fetch(API_BASE + "/api/categories");
            let list = [];
            if (r.ok) list = await r.json();
            const mapped = list.map((c) => ({
              id: c.id || c.name,
              name: c.name || c.id,
            }));
            const merged = merge(defaultCats, mapped);
            sel.innerHTML =
              '<option value="">-- Select category --</option>' +
              merged
                .map((c) => `<option value="${c.id}">${c.name}</option>`)
                .join("\n");
          } catch (e) {
            // fallback to defaults
            sel.innerHTML =
              '<option value="">-- Select category --</option>' +
              defaultCats
                .map((c) => `<option value="${c.id}">${c.name}</option>`)
                .join("\n");
          }
        }

        // Load categories when admin content becomes visible
        if (token && user && user.role === "admin") loadAdminCats();
      })();
    </script>
  </body>
</html>
